<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snakes & Ladders — Editor</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121a22; --muted:#7f93aa; --text:#e7eef7; --accent:#66d9ff; --danger:#ff5c5c; }
    * { box-sizing: border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:var(--bg); color:var(--text); }

    header { padding:12px 16px; border-bottom:1px solid #1d2a38; display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    header h1 { margin:0; font-size:16px; letter-spacing:.2px; }

    .wrap {
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      padding:12px;
    }
    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }

    .panel { background:var(--panel); border:1px solid #1d2a38; border-radius:12px; padding:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input, select, textarea, button {
      background:#0e141c; color:var(--text);
      border:1px solid #223244; border-radius:10px;
      padding:8px 10px; outline:none;
    }
    textarea { width:100%; min-height:90px; resize:vertical; }
    button { cursor:pointer; }
    button.primary { border-color:#2a5666; background:#0d2630; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:var(--muted); font-size:12px; }
    .small { font-size:11px; }
    .hr { height:1px; background:#1d2a38; margin:10px 0; }

    .inline { display:flex; gap:8px; }
    .inline > * { flex:1; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .grid { display:grid; grid-template-columns: repeat(var(--cols), minmax(34px, 1fr)); gap:6px; }
    .tile {
      border:1px solid #223244; border-radius:10px;
      padding:8px 6px; text-align:center; font-size:12px;
      background:#0e141c; cursor:pointer; user-select:none;
      display:flex; flex-direction:column; gap:6px; align-items:center; justify-content:center;
      aspect-ratio: 1 / 1;
      min-height: 54px;
    }
    .tile .n { font-weight:800; }
    .tile .k { font-size:10px; color:var(--muted); }
    .tile.sel { outline:2px solid var(--accent); }

    .pill {
      border:1px solid #223244; border-radius:999px;
      padding:6px 10px; font-size:12px; color:var(--muted);
      display:flex; gap:8px; align-items:center;
      background:#0e141c;
    }
    .pill b { color: var(--text); font-weight: 800; }

    .copybox {
      border:1px solid #223244; border-radius:12px;
      padding:8px 10px;
      background:#0e141c;
      cursor: pointer;
      user-select: none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .copybox:hover { border-color:#2a5666; }
    .copybox .url { color: var(--text); font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .copybox .hint { color: var(--muted); font-size:11px; }

    .preview {
      width:100%; aspect-ratio: 1 / 1; border-radius:12px;
      border:1px solid #223244; background:#0e141c;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .preview img { width:100%; height:100%; object-fit:contain; display:block; }
  </style>
</head>

<body>
<header>
  <h1 id="titleText">Snakes &amp; Ladders — Editor</h1>

  <div class="row" style="flex:1; min-width: 280px;">
    <input id="apiBase" style="max-width:320px" type="text" placeholder="API Base (optional)" />
    <input id="gameId" style="max-width:360px" type="text" placeholder="Game ID (game_...)" />
    <button class="primary" id="loadBtn">Load</button>
  </div>

  <div class="row">
    <div class="pill"><span>Locked:</span> <b id="lockStatus">unknown</b></div>
    <div class="pill"><span>Updated:</span> <b id="updatedStatus">—</b></div>
  </div>

  <div class="row" style="width:100%;">
    <button class="primary" id="openIndexTop">Back to Index</button>
    <button class="primary" id="openViewerTop">Open Viewer</button>
    <div class="muted small" id="statusText" style="width:100%;">Ready.</div>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Game + Tile Edit -->
  <div class="panel">
    <div style="font-size:14px; font-weight:800;">Game Setup</div>
    <div class="muted small">Editor never shows Join Code (only Index does).</div>
    <div class="hr"></div>

    <div class="muted small">Game ID</div>
    <div class="inline" style="margin-top:8px">
      <input id="gameIdOut" class="mono" readonly />
      <button id="copyGameId" class="primary">Copy</button>
    </div>

    <div class="inline" style="margin-top:10px">
      <button id="openViewer">Open Board Viewer</button>
      <button id="openIndex">Back to Index</button>
    </div>

    <div class="hr"></div>

    <div style="font-size:14px; font-weight:800;">Board</div>
    <div class="row" style="margin-top:8px">
      <div style="flex:1">
        <label>Columns</label>
        <input id="cols" type="number" min="5" max="40" value="10" />
      </div>
      <div style="flex:1">
        <label>Tiles Base Path</label>
        <input id="tilesBasePath" placeholder="tiles" />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="primary" id="saveBtn">Save Board</button>
      <button id="toggleLockBtn">Toggle Lock</button>
    </div>

    <div class="hr"></div>

    <div style="font-size:14px; font-weight:800;">Tile</div>
    <div class="muted small" id="tileSub">Click a tile to edit.</div>

    <div class="hr"></div>

    <div class="preview" id="preview">
      <span class="muted small">No image</span>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Index</label>
        <input id="t_id" class="mono" readonly />
      </div>
      <div style="flex:1">
        <label>Kind</label>
        <select id="t_type">
          <option value="task">task</option>
          <option value="jump">jump</option>
          <option value="boss">boss</option>
          <option value="empty">empty</option>
          <option value="start">start</option>
          <option value="finish">finish</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>Title</label>
      <input id="t_title" placeholder="e.g. Vorkath Unique" />
    </div>

    <div style="margin-top:10px">
      <label>Description</label>
      <textarea id="t_desc" placeholder="Tile instructions..."></textarea>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Category (optional)</label>
        <input id="t_cat" placeholder="boss / skilling / meme..." />
      </div>
      <div style="flex:1">
        <label>Requires Proof</label>
        <select id="t_proof">
          <option value="true" selected>true</option>
          <option value="false">false</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <label>Jump To (only for jump)</label>
        <input id="t_jumpTo" type="number" placeholder="e.g. 42" />
      </div>
      <div style="flex:1">
        <label>Image (url or filename)</label>
        <input id="t_img" placeholder="ranger_boots.png OR https://..." />
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button class="primary" id="applyTileBtn">Apply Tile</button>
      <button id="resetTileBtn">Reset Tile</button>
    </div>
  </div>

  <!-- RIGHT: Grid -->
  <div class="panel">
    <div class="row" style="justify-content:space-between;">
      <div>
        <div style="font-size:14px; font-weight:800;">Board Grid</div>
        <div class="muted small" id="gameMeta">Not loaded.</div>
      </div>
      <div class="row">
        <span class="muted small">Click tiles to edit.</span>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid" id="grid"></div>
  </div>
</div>

<script>
  // ---------- state ----------
  let boardResp = null;   // { board, locked, updatedAt }
  let selectedId = null;

  const el = (id) => document.getElementById(id);

  const apiBaseEl = el("apiBase");
  const gameIdEl = el("gameId");
  const loadBtn = el("loadBtn");

  const titleTextEl = el("titleText");
  const statusTextEl = el("statusText");
  const lockStatusEl = el("lockStatus");
  const updatedStatusEl = el("updatedStatus");
  const gameMetaEl = el("gameMeta");

  const openIndexTop = el("openIndexTop");
  const openViewerTop = el("openViewerTop");

  const gameIdOut = el("gameIdOut");
  const copyGameId = el("copyGameId");
  const openViewer = el("openViewer");
  const openIndex = el("openIndex");

  const colsEl = el("cols");
  const tilesBasePathEl = el("tilesBasePath");

  const saveBtn = el("saveBtn");
  const toggleLockBtn = el("toggleLockBtn");

  const tileSubEl = el("tileSub");
  const previewEl = el("preview");

  const t_id = el("t_id");
  const t_type = el("t_type");
  const t_title = el("t_title");
  const t_desc = el("t_desc");
  const t_cat = el("t_cat");
  const t_proof = el("t_proof");
  const t_jumpTo = el("t_jumpTo");
  const t_img = el("t_img");

  const applyTileBtn = el("applyTileBtn");
  const resetTileBtn = el("resetTileBtn");

  const gridEl = el("grid");

  function setStatus(msg){ statusTextEl.textContent = msg; }

  function apiBase(){
    const v = (apiBaseEl.value || "").trim();
    return v ? v.replace(/\/+$/, "") : "";
  }

  function getGameId(){
    return (gameIdEl.value || "").trim();
  }

  function endpoint(path){
    const base = apiBase();
    return (base ? base : "") + path;
  }

  function qsGet(name){
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function httpJson(method, url, body, headers = {}){
    const opts = { method, headers: { "Content-Type":"application/json", ...headers }, cache:"no-store" };
    if (body !== undefined) opts.body = JSON.stringify(body);
    return fetch(url, opts).then(async (res) => {
      const txt = await res.text();
      let data = null;
      try { data = txt ? JSON.parse(txt) : null; } catch {}
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : (txt || ("HTTP " + res.status));
        throw new Error(msg);
      }
      return data;
    });
  }

  function safeLower(s){ return (s || "").toString().toLowerCase(); }

  function defaultTileFor(index, boardSize){
    if (index === 0) return { id:index, type:"start", title:"Start", description:"", requiresProof:false };
    if (index === boardSize) return { id:index, type:"finish", title:"Finish", description:"", requiresProof:false };
    return { id:index, type:"task", title:"", description:"", requiresProof:true };
  }

  function boardSize(){
    return Number(boardResp?.board?.boardSize || 0);
  }

  function getBoardTile(index){
    const b = boardResp?.board;
    const size = boardSize();
    if (!b || !Array.isArray(b.tiles)) return defaultTileFor(index, size);

    const hit = b.tiles.find(t => Number(t.id) === Number(index));
    if (hit) return hit;

    return defaultTileFor(index, size);
  }

  function setHeaderMeta(){
    lockStatusEl.textContent =
      boardResp?.locked === true ? "LOCKED" :
      boardResp?.locked === false ? "UNLOCKED" : "unknown";

    updatedStatusEl.textContent = boardResp?.updatedAt ? String(boardResp.updatedAt) : "—";

    const gid = getGameId();
    titleTextEl.textContent = gid ? `Snakes & Ladders — Editor (${gid})` : "Snakes & Ladders — Editor";

    if (!boardResp?.board){
      gameMetaEl.textContent = "Not loaded.";
      return;
    }
    gameMetaEl.textContent = `Board size: ${boardSize()} • Tiles: ${(boardResp.board.tiles || []).length}`;
  }

  function resolveImageSrc(tile){
    const imgValue = (tile?.image || "").toString().trim();
    if (!imgValue) return "";
    if (/^https?:\/\//i.test(imgValue)) return imgValue;
    const basePath = ((boardResp?.board?.tilesBasePath) || "tiles").toString().replace(/\/+$/,"");
    return `${basePath}/${imgValue}`;
  }

  function renderGrid(){
    const size = boardSize();
    if (!size) { gridEl.innerHTML = ""; return; }

    gridEl.style.setProperty("--cols", String(Number(colsEl.value) || 10));
    gridEl.innerHTML = "";

    for (let i=0; i<=size; i++){
      const tile = getBoardTile(i);

      const div = document.createElement("div");
      div.className = "tile" + (selectedId === i ? " sel" : "");
      div.onclick = () => selectTile(i);

      const n = document.createElement("div");
      n.className = "n";
      n.textContent = i;

      const k = document.createElement("div");
      k.className = "k";
      k.textContent = safeLower(tile.type || "");

      div.appendChild(n);
      div.appendChild(k);
      gridEl.appendChild(div);
    }
  }

  function renderTileEditor(){
    const size = boardSize();
    if (selectedId === null || !size){
      tileSubEl.textContent = "Click a tile to edit.";
      previewEl.innerHTML = '<span class="muted small">No image</span>';
      t_id.value = "";
      return;
    }

    const tile = getBoardTile(selectedId);
    tileSubEl.textContent = `Editing tile ${selectedId}`;

    t_id.value = String(selectedId);
    t_type.value = String(tile.type || "task");
    t_title.value = String(tile.title || "");
    t_desc.value = String(tile.description || "");
    t_cat.value = String(tile.category || "");
    t_proof.value = (tile.requiresProof === false) ? "false" : "true";
    t_jumpTo.value = (tile.jumpTo === null || tile.jumpTo === undefined) ? "" : String(tile.jumpTo);
    t_img.value = String(tile.image || "");

    const src = resolveImageSrc(tile);
    if (src){
      previewEl.innerHTML = "";
      const img = document.createElement("img");
      img.referrerPolicy = "no-referrer";
      img.src = src;
      img.onerror = () => { previewEl.innerHTML = '<span class="muted small">Image failed to load</span>'; };
      previewEl.appendChild(img);
    } else {
      previewEl.innerHTML = '<span class="muted small">No image</span>';
    }
  }

  function selectTile(id){
    selectedId = id;
    renderGrid();
    renderTileEditor();
  }

  function ensureBoardTilesArray(){
    if (!boardResp || !boardResp.board) return;
    if (!Array.isArray(boardResp.board.tiles)) boardResp.board.tiles = [];
  }

  function upsertTile(tile){
    ensureBoardTilesArray();
    const tiles = boardResp.board.tiles;
    const idx = tiles.findIndex(t => Number(t.id) === Number(tile.id));
    if (idx >= 0) tiles[idx] = tile;
    else tiles.push(tile);
  }

  function deleteTile(index){
    ensureBoardTilesArray();
    const tiles = boardResp.board.tiles;
    const idx = tiles.findIndex(t => Number(t.id) === Number(index));
    if (idx >= 0) tiles.splice(idx, 1);
  }

  async function loadBoardOnce(gameId){
    const url = endpoint(`/games/${encodeURIComponent(gameId)}/board`);
    boardResp = await httpJson("GET", url);
  }

  async function saveBoardOnce(gameId){
    const url = endpoint(`/games/${encodeURIComponent(gameId)}/board`);
    // server expects { board: {...} }
    await httpJson("PUT", url, { board: boardResp.board });
  }

  async function toggleLockOnce(gameId){
    const url = endpoint(`/games/${encodeURIComponent(gameId)}/board/lock`);
    const out = await httpJson("POST", url, {});
    if (out && typeof out.locked === "boolean") boardResp.locked = out.locked;
  }

  function goIndex(){ location.href = "index.html"; }

  function goViewer(){
    const gid = getGameId();
    if (!gid) return goIndex();
    location.href = "view.html?gameId=" + encodeURIComponent(gid);
  }

  async function copyText(value){
    try {
      await navigator.clipboard.writeText(value);
      return true;
    } catch {
      return false;
    }
  }

  function wireNavButtons(){
    const gid = getGameId();
    gameIdOut.value = gid;

    copyGameId.onclick = () => copyText(gid);

    openIndex.onclick = goIndex;
    openViewer.onclick = goViewer;

    openIndexTop.onclick = goIndex;
    openViewerTop.onclick = goViewer;

  }

  // ---------- events ----------
  loadBtn.onclick = async () => {
    const gid = getGameId();
    if (!gid) return setStatus("Enter Game ID.");

    try {
      setStatus("Loading...");
      await loadBoardOnce(gid);

      // sync UI defaults
      colsEl.value = String(Number(colsEl.value) || 10);
      tilesBasePathEl.value = String(boardResp?.board?.tilesBasePath || "tiles");

      selectedId = 0;

      wireNavButtons();
      setHeaderMeta();
      renderGrid();
      renderTileEditor();
      setStatus("Loaded.");
    } catch (e){
      console.error(e);
      setStatus("Load failed: " + (e?.message || String(e)));
    }
  };

  colsEl.onchange = () => renderGrid();

  tilesBasePathEl.onchange = () => {
    if (boardResp?.board) boardResp.board.tilesBasePath = (tilesBasePathEl.value || "tiles").trim() || "tiles";
    renderTileEditor();
  };

  applyTileBtn.onclick = () => {
    if (!boardResp?.board) return;

    const id = Number(t_id.value || "");
    if (!Number.isFinite(id)) return;

    const type = (t_type.value || "task").trim();

    const tile = {
      id,
      type,
      title: (t_title.value || "").trim(),
      description: (t_desc.value || "").trim(),
      category: (t_cat.value || "").trim() || undefined,
      requiresProof: (t_proof.value === "true"),
      jumpTo: (t_jumpTo.value.trim() === "" ? undefined : Number(t_jumpTo.value)),
      image: (t_img.value || "").trim() || undefined
    };

    if (!Number.isFinite(tile.jumpTo)) tile.jumpTo = undefined;
    if (type !== "jump") tile.jumpTo = undefined;

    if (!tile.title) delete tile.title;
    if (!tile.description) delete tile.description;
    if (!tile.image) delete tile.image;

    upsertTile(tile);
    renderGrid();
    renderTileEditor();
    setStatus(`Tile ${id} updated (local). Click Save Board to persist.`);
  };

  resetTileBtn.onclick = () => {
    if (selectedId === null) return;
    deleteTile(selectedId);
    renderGrid();
    renderTileEditor();
    setStatus(`Tile ${selectedId} reset to default (local). Click Save Board to persist.`);
  };

  saveBtn.onclick = async () => {
    const gid = getGameId();
    if (!gid || !boardResp?.board) return;

    try {
      setStatus("Saving...");
      boardResp.board.tilesBasePath = (tilesBasePathEl.value || "tiles").trim() || "tiles";
      await saveBoardOnce(gid);
      await loadBoardOnce(gid);
      setHeaderMeta();
      setStatus("Saved.");
    } catch (e){
      console.error(e);
      setStatus("Save failed: " + (e?.message || String(e)));
    }
  };

  toggleLockBtn.onclick = async () => {
    const gid = getGameId();
    if (!gid) return;

    try {
      setStatus("Toggling lock...");
      await toggleLockOnce(gid);
      await loadBoardOnce(gid);
      setHeaderMeta();
      setStatus("Lock updated.");
    } catch (e){
      console.error(e);
      setStatus("Lock toggle failed: " + (e?.message || String(e)));
    }
  };

  // ---------- init ----------
  apiBaseEl.value = ""; // same-origin default
  const qpGameId = qsGet("gameId");
  if (qpGameId) gameIdEl.value = qpGameId;

  wireNavButtons();
  setHeaderMeta();

  if (qpGameId) {
    loadBtn.click();
  } else {
    setStatus("Ready. Enter a Game ID and click Load.");
  }
</script>
</body>
</html>
